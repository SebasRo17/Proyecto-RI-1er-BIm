spent time trying figure making slow calculation following array actually supersimple toy model input array nx ny nn nx ny nband nstates nn nband eigenvectors table range nstates nstates inverseflatten l dimension fold partition flatten l reverse dimension n module ix iy n x ix mod nx iy quotient nx ix nx n x n x ix n x iy nx uv inverseflatten eigenvectors nstates nband nn u uv nstates nband v uv nstates nband f range nstates v table memberq n j true l nband nband nband q nband nn j nn array delta table total flatten v table table memberq n j true f u q conjugate v j nn j nn q nband nband nband nband tried several thing like using packed array using compile seen nothing really helped thing actually slows thing think process lot faster instead using give condition matrix element calculate directly specify position would like calculate matrix element think number element calculated really small compared number element big nn looking sparsearray list manipulating tutorial saw one using pattern example normal sparsearray nn nn specifies second index matrix function n defined therefore would like use something like normal sparsearray n nn nn sparsearray posd left hand side n x quotient n x quotient position pattern match position element array dimension complaint expect get since n n anybody could make pattern sparsearray function n pattern thanks