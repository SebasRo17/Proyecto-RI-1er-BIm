work embedded system frequently required implement protocol like make nice clean layer however become difficult field used different layer shared like think layer offering number service following spirit osi model framing num start byte sequence num length packet message num message integrity crc xor checksum network num source destination application num command response interpret payload realize iso model get point hope sometimes protocol exists point point link rs232 tcp socket concept source destination would typically software layer framing network application layer typically state machine processing byte frame packet top hook point application specific functionality typically packet move stack layer stripped simply pas pointer next inner scope first pointer pointer network field finally pointer application payload field parsed added structure specific layer producing structure like frame packet message command response structure pointer packet buffer top deallocate structure calling free layer bottom pointer available free pool question cleanly handle case field dual use bit field byte upper nibble payload length lower nibble packet etc example simple packet format like cmd command specific payload crc case length packet implied command cmd field single byte case shared framing application layer think case framing layer lookup table command length pass pointer cmd field application layer handling structure