dealing old sloppy c structure lot member function want test implemented us struct dependency going make unit test extremely ugly inspired michael discussion preprocessing seam working effectively legacy getting ready solve problem faking ugly structure preprocessor inheritance polymorphism demonstrated following notional test cpp include iostream include hpp include hpp std cout getdescription std endl hpp ifndef depends ugly hpp define depends ugly hpp include include ugly hpp public std getdescription depends ugly getname endif ugly hpp ifndef ugly hpp define ugly hpp struct ugly double b z std getname ugly endif hpp ifndef ugly hpp ugly hpp deliberately define ugly hpp struct ugly duplicate deliberate std getname ugly depends endif special fake using inclined call stub rather different would normally think stub would expect something called stub implement interface faked inheritance implementation partial happens preprocessor already known kind fake testing want header file contains hpp example properly signify developer