using term depth agnostic post describe structural pattern featuring target sub pattern occur depth relative one context sub pattern simple example depth agnostic pattern consider following rewrite rule rr replace expression wrap x expression x tgt contained somewhere within expression ctx target context sub pattern x tgt ctx respectively depth agnostic bit come phrase somewhere within word rr say find expression look like ctx yk tgt number nested subexpressions yk indeterminate rewrite ctx yk wrap tgt thus defined ping foo ctx bar tgt ding foo ctx bar tgt pong foo baz bar tgt according rr ping would changed foo ctx bar wrap tgt ding would changed foo ctx bar wrap tgt hand pong would unaffected rr even though contains expression tgt expression occur somewhere within expression ctx problem implement rewrite rule feature depth agnostic pattern mathematica see depth agnosticity issue consider rewrite rule rr identical every way rr except specifies single unambiguous depth target relative context sub pattern iow depth agnostic rr replace expression wrap x expression x tgt contained depth within expression ctx shown implementing rr mathematica straightforward though admittedly bit tedious unfortunately nowhere general rr e g rr affect ping ding one rather uninspired implementation rr action ping ding pong ctx h h x tgt z z z ctx h h wrap x z z z tableform foo ctx bar wrap tgt foo ctx bar tgt foo baz bar tgt implementation fulfills earlier assertion rr like rr respect ping affect pong affect respect ding rr affect ding rr least two important generalization idea described first one situation multiple context sub pattern indeterminate depth relative example rr replace expression wrap x expression x tgt contained somewhere within expression ctx contained somewhere within expression list second generalization could expressed allowing negative depth word pattern context sub pattern contained within target subpattern example rr replace expression wrap x expression x tgt containing somewhere within expression ctx post resort mathematica notation pattern namely h denotes pattern matching expression head h x h denotes pattern matching expression henceforth referred x head h abuse notation slightly writing expression h shorthand expression matching pattern h expression x h shorthand expression henceforth referred x matching pattern h