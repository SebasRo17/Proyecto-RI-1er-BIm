minimal example problem f b c orderedq b c h b c f c b f b b c setattributes g flat g b c orderedq b c h b c g c b g b b c f function work great g function go infinite loop work around problem perhaps alternative flat attribute way defining commutation relation way set attribute flat g b b c often built follows setattributes g flat g b g g b c thanks alephalpha explaining problem suggesting following fix edit actually implementation still run infinite loop second test case independent order definition edit found fix loop flatten g instead declaring flat attribute next line failed attempt get overwritten g b g c flatten g b c line work g b g c module temp temp flatten hold g b c infinity g release g b c orderedq b c h b c g c b g b b c g b g g b c sure affect pattern matching definition leave question open see others come possibly get discussion pro con flat v flatten