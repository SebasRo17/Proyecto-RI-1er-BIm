trouble getting customized derivative defined using upvalues behave sane way mean like define derivative using upvalue mathematica apply derivative rule normally would delegating upvalues appropriate example x x x kroneckerdelta x x b kroneckerdelta x x x x give expected answer x x x x desired output b x x x x desired output x x x b latter two get x x x x x x x x x understanding upvalues kicking similar question asked adjust problem update look like specify problem enough detail give better sense direction looking see question present understanding derivative suggests cannot achieve want since argument function abstract index e g multiple argument implicit consider discrete joint probability p xy j j index unspecified range represent possible value consider marginal distribution p x sum j p xy j p x depends p xy j k j hoping declare derivative p xy j p x respect p xy k l treating p xy j independent variable wanted able differentiate generic expression involving function mathematically behavior frac partial p xy j partial p xy k l delta ij delta jk qquad qquad frac partial p x partial p xy k l delta ik toy expression like differentiate frac partial partial p xy k l left p xy j p x right delta ik delta jl p x p xy j p x delta ik application product rule pretty straight forward calculation hand derivative primitive specified however want specify rule differentiation somehow like tell mathematica use system incorporating primitive thing tried pxy pxy j pxy k l simplify kroneckerdelta k kroneckerdelta j l px px pxy j k kroneckerdelta j pxy j px pxy k l undesirably return think understand via pattern matching give another attempt pxy pxy j pxy k l simplify kroneckerdelta k kroneckerdelta j l px mysumx pxy j j mysum mysum j pxy k l k j l pxy k l mysumx mysumx j pxy k l k pxy k l px pxy k result correct pxy j px pxy k l result correct hopefully clearer original question relates truly keep fun another expression like differentiate frac partial partial p xy k l sum j p xy j log frac p xy j p x p j