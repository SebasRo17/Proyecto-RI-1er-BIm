refactor complex c app many dialog mixed logic part managing communication special hardware sending command receive via asynchronous c callback spaghetti mixed ui logic communication etc task split layer ddd sense layer belongs callback driver routine callback creating bubble system ui layer cannot enforce essential principle element layer depends element layer element layer beneath