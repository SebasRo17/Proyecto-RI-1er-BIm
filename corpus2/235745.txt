I am currently making multiple parsers using PEGjs and have implemented my own partial preprocessor which using a RegExp finds and replaces '#include' directives with the desired files, resulting in a bundled file. Now I can easily find a problem in my PEGjs syntax if I save this bundled file and then try building the parser, but since I'm working now with multiple parsers, I don't want to take this method, so was making a new preprocessor that saves the start/end offsets into an array that is checked when an error occurs while building the parser and looks for the correct file and calculates the real offset. Iv'e gotten to the part where I can find the correct file, but can't seem to figure out how to calculate the correct offset. Here's a gist link that shows 'the fruits of my labour': https://gist.github.com/futagoza/10520299   The part where I'm calculating the correct offset is the function 'buildPosDetails' on line 47 (it's easy to tell I'm bad at maths :D)